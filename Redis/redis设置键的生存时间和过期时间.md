## Redis设置key的生存时间和过期时间

- Redis有四种不同的命令用于设置键的生存时间(键可以存在多久)或者过期时间(键什么时候会被删除).

  1. EXPIRE <key> <ttl> 命令用于将键的key的生存时间设置为 ttl 秒.
  2. PEXPIRE <key> <ttl> 命令用于将键 key 的生存时间设置为 ttl 毫秒.
  3. EXPIREAT <key> <timestamp> 用于将键 key 的过期时间设置为 timestamp 所指定的秒数时间戳.
  4. PEXPIREAT <key> <timestamp> 用于将键 key 的过期时间设置为 timestamp 所指定的毫秒数时间戳.

- 保存过期时间
  redisDb 结构的 expires 字典保存了数据库中所有键的过期时间, 我们称这个字典为过期字典.
  (1)过期字典的键是一个指针, 这个指针指向键空间中的某个键对象. 
  (2)过期字典的值是一个 long long 类型的整数. 这个整数保存了键所
  指向的数据库键的过期时间(一个毫秒精确的时间戳).

  带有过期字典的数据库例子:
  虽然图中键空间和过期字典中重复出现了两次 alphabet 键对象和 book 键对象, 在实际中, 键空间的键和过期字典的键都指向同一个键对象, 所以不会出现任何重复对象, 也不会浪费任何空间.当客户端执行 PEXPIREAT 命令为一个数据库键设置过期时间时, 服务器会在数据库的过期字典中关联给定的数据库键和过期时间.

  移除过期时间
  PERSIST命令可以移除一个键的过期时间.
  PERSIST命令就是 PEXPIREAT 命令的反操作, PERSIST命令在过期字典中查找给定的键, 并解除键和值(过期时间)在过期字典中的关联.
  
过期键的判定
  
- 通过过期字典, 程序可以用以下步骤检查一个给定键是否过期:
    (1) 检查给定的键是否存在于过期字典, 如果存在, 取得键的过期时间.
    (2) 检查当前时间戳是否大于键的过期时间, 如果是的话, 那么键已经过期, 否则的话, 键未过期.
  
- 过期键删除策略
  如果一个键过期了, 什么时候会被删除?
  有三种不同的删除策略:
  (1)定时删除
  在设置键的过期时间的同时, 创建一个定时器, 让定时器在键的过期时间来临时, 立即执行对键的删除操作.
  (2)惰性删除
  放任键过期不管, 但是每次从键空间中获取键时, 都检查取得的键是否过期, 如果过期的话, 就删除该键, 如果没有过期, 就返回该键.
  (3)定期删除
  每隔一段时间, 程序就对数据库进行一次检查, 删除里面的过期键.
  - 定时删除
    定时删除对内存时最友好的, 通过使用定时器, 定时删除策略可以保证过期键会尽可能快地被删除, 并释放过期键所占用的内存.定时删除的缺点是; 它对CPU时间是不友好的, 在过期键比较多的情况下, 删除过期键这一行为可能会占用相当一部分CPU, 在CPU非常紧张的情况下, 将CPU时间用在删除和当前任务无关的过期键上, 会对服务器的吞吐量造成影响.
  - 惰性删除
    惰性删除对CPU时间来说是最友好的, 程序只有在取出键时才对键进行过期检查, 这可以保证删除的目标仅限于当前处理的键,这个策略不会在其他任何无关的键上花费CPU时间.惰性删除的缺点是: 它对内存是不友好的, 如果一个键已经过期, 而这个键仍然保留到数据库中, 那么只要这个过期键不被删除, 它所占用的内存就不会被释放.使用惰性删除, 如果数据库中有非常多的过期键, 而这些过期键又恰好没有被访问到, 也许永远都不会被删除(除非手动flushdb), 无用的垃圾会占用大量的内存, 对Redis的性能会造成影响.
  - 定期删除 
    定期删除策略是前两种策略的一种整合和折中:
    定期删除策略每隔一段时间执行一次删除过期键的操作, 通过限制删除操作执行的频率来减少对CPU时间的影响.
    通过定期的删除过期键, 有效地减少了因为过期键而带来的内存浪费.定期删除策略的难点是: 确定删除操作执行的时长和频率.如果删除操作执行的太频繁, 就会将CPU时间过多的消耗在删除过期键上面, 如果删除操作执行的得太少, 就会对出现对内存浪费的情况.
  
- Redis的过期键删除策略
  Redis使用的是惰性删除和定期删除这两种策略. 通过配合使用这两种策略, 服务器可以很好的合理使用CPU时间和避免
  内存浪费之间取得平衡.
  (1)惰性删除策略的实现
  过期键的惰性删除策略由 expireIfNeeded 函数实现, 所有读写数据库的Redis命令在执行之前都会调用expireIfNeeded 函数对输入键进行检查. 如果键已经过期, 那么会将输入的键从数据库删掉. 如果输入键未过期, 那么不做任何操作.
  (2)定期删除策略的实现
  Redis会周期性的执行一个函数, 这个函数在规定时间内, 分多次遍历服务器中的各个数据库, 从数据库的过期字典中随机检查一部分键的过期时间, 并删除其中的过期键.AOF, RDB和复制功能对过期键的处理在执行SAVE命令会创建一个新的 RDB 文件, 程序会对过期键进行检查, 已过期的键不会被保存到新创建的 RDB 文件中.数据库中包含过期键不会对新的 RDB 文件造成影响.