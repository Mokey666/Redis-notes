## Redis事件

- Redis服务器是一个事件驱动程序, 服务器需要处理以下两类事件:

  - 文件事件(file event): Redis服务器通过套接字与客户端进行连接, 而文件事件就是服务器对套接字操作的抽象.

    例如：客户端发送一个get请求。

  - 时间事件(time event): Redis服务器中的一些操作需要在给定的时间点执行, 而时间事件就是服务器对这类定时操作的抽象.

    例如：定期的处理RDB文件。

- Reactor模式

  - **I/O多路复用技术**（epoll）

- **文件事件**

  - Redis基于Reactor模式开发了自己的网络事件处理器, 这个处理器被称为文件事件处理器.
    文件事件处理器使用 I/O 多路复用程序来同时监听多个套接字, 并根据套接字的目前执行的任务来为套接字关联不同的事件处理器. 当被监听的套接字准备好读取, 写入等操作时, 与操作对应的文件事件就会产生, 文件事件处理器就会调用套接字之前关联好的事件处理器来处理这些事件.
  - ![1568473743682](C:\Users\侯泽明\AppData\Roaming\Typora\typora-user-images\1568473743682.png)
  - **执行过程** ：当一个套接字准备好执行连接应答等操作时, 就会产生一个文件事件, I/O多路复用程序负责监听多个套接字, 并向文件事件分派器传送那些产生了事件的套接字. 尽管多个文件事件可能会并发的出现, 但是I/O多路复用程序总是会将所有产生事件的套接字放在一个队列里面, 然后通过这个队列有序的, 同步的向文件事件分派器传送套接字, 当一个套接字上产生的事件被处理完毕之后, I/O多路复用程序才会向文件事件分派器传送下一个套接字.
  - ![1568474678680](C:\Users\侯泽明\AppData\Roaming\Typora\typora-user-images\1568474678680.png)

  
  - 文件事件处理器的结构包含 4 个部分：
    - 多个 socket：多个 socket 可能会并发产生不同的操作，每个操作对应不同的文件事件。
    - IO 多路复用程序：监听多个socket，会将socket产生的事件放入到一个队列里面，然后向文件事件分派器有序的，同步的传送套接字。
    - 文件事件分派器：将这个socket所产生的事件，交给对应的事件处理器。
    - 事件处理器（连接应答处理器、命令请求处理器、命令回复处理器）：处理事件。

- **时间事件**

  - Redis的时间事件分为以下两类:
    (1)定时事件: 让一段程序在指定的时间之后执行一次.
    (2)周期性事件: 让一段程序每隔指定时间就执行一次. 
    目前Redis只使用周期性事件, 而没有使用定时事件.
    实现:
    服务器将所有时间事件放在一个无序链表中, 每当事件执行器运行时, 就遍历整个链表, 查找所有已经到达的时间事件, 并调用相应的事件处理器.
    一个时间事件主要由以下三个属性组成:
    (1) id
    服务器为时间事件创建的全局唯一ID. ID号按照从小到大的顺序递增, 新事件的ID号比旧事件的ID号要大.
    (2) when
    毫秒精确的UNIX时间戳, 记录了时间事件的到达时间.
    (3) timeProc
    时间事件处理器. 一个函数, 当时间事件到达时, 服务器就会调用相应的处理器来处理事件.

    

    保存时间事件的链表为无序链表, 指的不是链表不按照ID排序, 而是该链表不按照 when 属性的大小排序. 正因为链表没有按照 when 属性的大小排序, 所以时间事件执行器运行时, 它必须遍历链表中的所有时间事件.

### Redis为什么是单线程的? 为什么Redis是一个单线程应用, 却拥有如此高的性能?

- Redis服务器是基于事件驱动的程序, 文件处理器以单线程的方式运行, 文件事件处理器使用I/O多路复用程序来监听多个套接字, 当一个套接字准备好执行连接应答等操作时, 就会产生一个文件事件, I/O多路复用器就会将产生文件事件的套接字放入一个队列中, 然后文件事件分派器将文件事件分发给对应的文件处理器去执行, 当一个套接字产生的事件被处理完毕之后, I/O多路复用器才会继续向文件事件分派器传送下一个套接字. 所以Redis是一个单线程的应用. 
  虽然Redis是一个单线程应用, 但是通过使用I/O多路复用程序来监听多个套接字, 文件事件处理器的运行实现了高性能.



## Redis单线程模型

- Redis客户端对服务端的每次调用都经历了发送命令，执行命令，返回结果三个过程。其中执行命令阶段，由于Redis是单线程来处理命令的，所有每一条到达服务端的命令不会立刻执行，所有的命令都会进入一个队列中，然后逐个被执行。并且多个客户端发送的命令的执行顺序是不确定的。但是可以确定的是不会有两条命令被同时执行，不会产生并发问题，这就是Redis的单线程基本模型。
- 2 单线程模型每秒万级别处理能力的原因
  （1）纯内存访问。数据存放在内存中，内存的响应时间大约是100纳秒，这是Redis每秒万亿级别访问的重要基础。
  （2）非阻塞I/O，Redis采用epoll做为I/O多路复用技术的实现，再加上Redis自身的事件处理模型将epoll中的连接，读写，关闭都转换为了时间，不在I/O上浪费过多的时间。
  （3）单线程避免了线程切换和竞态产生的消耗。
  （4）Redis采用单线程模型，每条命令执行如果占用大量时间，会造成其他线程阻塞，对于Redis这种高性能服务是致命的，所以Redis是面向高速执行的数据库。





### 题外话

- 总结多路 I/O 复用模型是利用select、poll、epoll可以同时监察多个流的 I/O 事件的能力，在空闲的时候，会把当前线程阻塞掉，当有一个或多个流有I/O事件时，就从阻塞态中唤醒，于是程序就会轮询一遍所有的流（epoll是只轮询那些真正发出了事件的流），并且只依次顺序的处理就绪的流，这种做法就避免了大量的无用操作。这里“多路”指的是多个网络连接，“复用”指的是复用同一个线程。采用多路 I/O 复用技术可以让单个线程高效的处理多个连接请求（尽量减少网络IO的时间消耗），且Redis在内存中操作数据的速度非常快（内存内的操作不会成为这里的性能瓶颈），主要以上两点造就了Redis具有很高的吞吐量。