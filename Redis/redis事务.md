## Redis事务

- 流程：MULTI(开启一个事务)--入队(Queue)--EXEC(执行)

  执行之前可能会执行Discard(放弃事务)；

- redis中的事务和mysql中的事务是不同的。

- 事务命令

  - 1.watch 
    用于监视一个或多个key，如果在事务执行之前这个或（这些）key被其他命令所改动，事务将被中断。

    watch就是一个乐观锁。

    2.unwatch 
    用于取消watch命令对所有key的监视。

    3.multi 
    用于标记一个事务块的开始，之后的所有命令都存放在队列，等遇到exec命令再执行。

    4.exec 
    
    用于执行事务块内所有的命令，如果命令被中断，返回false 
    
    5.Discard(放弃事务)

- 事务中的错误

  - 使用事务时可能会遇到以下两种错误:
    (1)事务在执行EXEC之前, 入队的命令可能出现错误, 比如, 命令可能产生语法错误等.
    (2)命令可能在EXEC调用之后失败, 比如将列表命令用在了字符串键上面等.
  - 第一种错误发生在EXEC之前, 通过检查命令的返回值来判断正确, 如果返回值为QUEUED, 那么就是成功, 不然就是失败, 从Redis2.6.5开始, 在命令排队期间发生错误, Redis会拒绝执行EXEC, 并放弃这个事务.在Redis2.6.5之前, EXEC调用之后, 会执行成功的命令, 而忽略失败的命令.
    对于那些在EXEC命令之后所产生的错误, 即使有某个命令在执行时产生了错误, 事务中的其他命令仍然会继续执行。

- 从三个Redis事务可能出现错误的三个地方, 说明Redis是如何确保事
  务的一致性
  1. 入队错误
  如果事务在入队命令中, 出现了命令不存在, 那么Redis拒绝执行这个事务.
  2. 执行过程中出现的错误
  即使在事务执行过程中, 出现错误, 这些错误都是在执行过程中被发现的, 服务器不会中断事务, 会继续执行剩余正确的命令, 已经执行的命令不会被出错的命令影响. 因为在事务执行过程中, 出错的命令会被服务器识别出来, 所以这些出错的命令不会对数据库做出任何修改, 也不会影响数据的一致性.
  3. 服务器停机
  如果Redis在执行事务的过程中停机, 可能出现以下情况:
  (1) 如果数据库没有启用任何持久化模式, 那么重启之后无数据, 因此数据总是一致的.
  (2) 如果使用的是RDB或AOF持久化模式, 事务中途停机不会导致不一致, 可以根据RDB/AOF文件来恢复数据库状态.

- ### Redis事务和传统数据库的事务最大的区别

  Redis不支持事务的回滚机制, 原因是: 事务回滚的复杂功能与Redis追求简单高效的设计原则不符合. 并且Redis事务的执行时错误通常都是编程错误造成的, 这种错误一般出现于开发中, 很少在生产环境中出现. 回滚并不能解决任何程序上的错误. 为了保证Redis的高效简单, 

  所以没有设置回滚机制.